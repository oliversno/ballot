<body>

<div class="container">
    <input id="tokenInput" type="text" value="token?">
    <button id="read" class="btn" type="button" onclick="fetchBallot()">Read</button>
    <div id="ballot">
        <div id="voteContainer">
            <!-- Voting here -->
        </div>
    </div>
</div>


<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.9.3/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.9.3/firebase-database.js"></script>
<!-- JQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script>
// Your web app's Firebase configuration
var firebaseConfig = {
apiKey: "AIzaSyByAyDFaMNDwKpfRhAQPk0B70ILYst-oS4",
authDomain: "ballot-d933a.firebaseapp.com",
databaseURL: "https://ballot-d933a.firebaseio.com",
projectId: "ballot-d933a",
storageBucket: "ballot-d933a.appspot.com",
messagingSenderId: "227086842486",
appId: "1:227086842486:web:849611a5373b9fc0ce7d57",
measurementId: "G-Y8X924EG6M"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);

function fetchBallot(){
    var token = document.getElementById('tokenInput').value
    firebase.database().ref('ballots/' + token).once('value').then(function(snapshot) {
        //TODO check if token is invalid
        var ballotType = (snapshot.val() && snapshot.val().ballotType);
        var candidates = (snapshot.val() && snapshot.val().candidateDict);
        clearBallot("voteContainer");
        // TODO Warn user about clearing ballot
        if(ballotType == "First Past the Post"){
            for(candidate in candidates){
                var div = $("<div />");
                div.html(getRadio(candidate));
                $("#voteContainer").append(div);
            }
        }
        else if(ballotType == "Ranked Choice"){
            for(candidate in candidates){
                var div = $("<div />");
                div.html(getRanking(candidate, candidates.length));
                $("#voteContainer").append(div);
            }
        }
        else if(ballotType == "Approval Voting"){
            for(candidate in candidates){
                var div = $("<div />");
                div.html(getCheck(candidate));
                $("#voteContainer").append(div);
            }
        }
        $("#ballot").append('<button id="castVote" class="btn" type="button">Vote!</button>');
        $("#castVote").bind("click", function () {
            //TODO
            if (ballotType == "First Past the Post" || ballotType == "Approval Voting"){
                var votes = document.getElementsByName('candidates')
                for(var i=0; i < votes.length; i++){
                    if(votes[i].checked){
                        //vote for votes[i].id
                        var key = 'ballots/' + token + '/candidateDict/' + votes[i].id;
                        firebase.database().ref(key).set(firebase.database.FieldValue.increment(1));
                    }
                }
            }
        });
    });
}

function clearBallot(elementID) {
    document.getElementById(elementID).innerHTML = "";
}

function getRadio(candidate) {
    return '<input name="candidates" id="' + candidate + '" type="radio"/>' + 
        '<label for="' + candidate + '">' + candidate + '</label><br>'
}

function getCheck(candidate) {
    return '<input name="candidates" id="' + candidate + '" type="checkbox"/>' + 
        '<label for="' + candidate + '">' + candidate + '</label><br>'
}

function getRanking(candidate, n) {
    var selection = '<p>' + candidate + ': </p>'
    // TODO use jquery UI sortable
    for(var i=0; i < n; i++){
        selection += '<input name="rankButton' + candidate + '" id="' + candidate + i + '" type="radio"/>' +
            '<label for="' + candidate + i + '">' + (i+1) + '<\label>'
    }
    return selection
}

</script>
</body>