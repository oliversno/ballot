<body>
<div class="container">
    <input id="tokenInput" type="text" value="token?">
    <button id="read" class="btn" type="button" onclick="fetchResults()">Get Results</button>
    <div id="displayRawData">
        <!-- raw data here -->
    </div>
    <div id="displayWinner">
        <!-- Winner Here -->
    </div>
</div>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.14/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.14/firebase-database.js"></script>
<!-- JQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script>
// Your web app's Firebase configuration
var firebaseConfig = {
apiKey: "AIzaSyByAyDFaMNDwKpfRhAQPk0B70ILYst-oS4",
authDomain: "ballot-d933a.firebaseapp.com",
databaseURL: "https://ballot-d933a.firebaseio.com",
projectId: "ballot-d933a",
storageBucket: "ballot-d933a.appspot.com",
messagingSenderId: "227086842486",
appId: "1:227086842486:web:849611a5373b9fc0ce7d57",
measurementId: "G-Y8X924EG6M"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);

function fetchResults(){
    var token = document.getElementById('tokenInput').value;
    //TODO make update in realtime
    firebase.database().ref('ballots/' + token).once('value').then(function(snapshot) {
        var ballotType = (snapshot.val() && snapshot.val().ballotType);
        var candidates = (snapshot.val() && snapshot.val().candidateDict);
        var numVotes = (snapshot.val() && snapshot.val.numVotes);
        if(ballotType == "First Past the Post" || ballotType == "Approval Voting"){
            for(var key in candidates){
                $("#displayRawData").append(getVotes(key, candidates[key]));
            }
            $("#displayWinner").append(
                '<h1>The Winnner is: ' + getWinner(candidates) + '</h1>');
        }
        else{ //ranked choice
            $("#displayWinner").append(
                '<h1>The Winnner is: ' + getWinnerRanked(candidates, numVotes) + '</h1>');
        }
    });
}

function getVotes(name, num){
    return '<p>' + name + ':' + num + '</p>'
}

function getWinner(candidates){
    return Object.keys(candidates).reduce(function(a, b) { 
        return candidates[a] > candidates[b] ? a : b 
    });
}

function getWinnerRanked(candidates, numVotes){
    var majorityWinner = "";
    var majorityLoser = "";
    while(majorityWinner == ""){
        majorityWinner, majorityLoser = simpleMajorityRanked(candidates, numVotes);
        if(majorityWinner != ""){
            return majorityWinner
        }
        // else
        for(vote in candidates[majorityLoser]){
            //reaportion
            var nextCandidate = vote[0];
            vote.splice(0,1); //remove first element
            candidates[nextCandidate].push(vote);
        }
        candidates[majorityLoser] = 0; //clear votes from loser
    }
}

function simpleMajorityRanked(candidates, numVotes){
    var majority = Math.ceil(numVotes / 2.0);
    var leastVotes = Number.MAX_SAFE_INTEGER;
    var leastCandidate = "";
    for(var key in candidates){
        var numVotes = 0;
        if(candidates[key] != 0){
            numVotes = candidates[key].length;
            // we only care about reapropriating votes if a candidate got votes
            if(numVotes < leastVotes){
                leastVotes = numVotes;
                leastCandidate = key;
            }
        }
        //todo check what happens when majority rounded and not
        if(numVotes >= majority){
            return key, ""
        }
    }
    return "", leastCandidate
}

</script>
</body>